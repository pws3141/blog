<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Paul Smith">
<meta name="dcterms.date" content="2025-03-17">

<title>Getting Started with {mlr3} – Paul Smith</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-37c1cdca8a883bbe9d5a264e3e9c59eb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta name="citation_title" content="Getting Started with {mlr3}">
<meta name="citation_author" content="Paul Smith">
<meta name="citation_publication_date" content="2025-03-17">
<meta name="citation_cover_date" content="2025-03-17">
<meta name="citation_year" content="2025">
<meta name="citation_online_date" content="2025-03-17">
<meta name="citation_fulltext_html_url" content="https://pws3141.github.io/blog/posts/08-mlr3_evaluation_benchmarking/">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Clmnis: An r package for downloading data from the parliamentary members names information service;,citation_author=Noel Dempsey;,citation_publication_date=2025;,citation_cover_date=2025;,citation_year=2025;,citation_fulltext_html_url=https://github.com/houseofcommonslibrary/clmnis;">
<meta name="citation_reference" content="citation_title=Highcharter: A wrapper for the ’highcharts’ library;,citation_author=Joshua Kunst;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_fulltext_html_url=https://CRAN.R-project.org/package=highcharter;">
<meta name="citation_reference" content="citation_title=Palmerpenguins: Palmer archipelago (antarctica) penguin data;,citation_author=Allison Marie Horst;,citation_author=Alison Presmanes Hill;,citation_author=Kristen B Gorman;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_fulltext_html_url=https://allisonhorst.github.io/palmerpenguins/;,citation_doi=10.5281/zenodo.3960218;">
<meta name="citation_reference" content="citation_title=Medicaldata: Data package for medical datasets;,citation_author=Peter Higgins;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://CRAN.R-project.org/package=medicaldata;">
<meta name="citation_reference" content="citation_title=Fontawesome: Easily work with ’font awesome’ icons;,citation_author=Richard Iannone;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://github.com/rstudio/fontawesome;">
<meta name="citation_reference" content="citation_title=Welcome to the tidyverse;,citation_author=Hadley Wickham;,citation_author=Mara Averick;,citation_author=Jennifer Bryan;,citation_author=Winston Chang;,citation_author=Lucy D’Agostino McGowan;,citation_author=Romain François;,citation_author=Garrett Grolemund;,citation_author=Alex Hayes;,citation_author=Lionel Henry;,citation_author=Jim Hester;,citation_author=Max Kuhn;,citation_author=Thomas Lin Pedersen;,citation_author=Evan Miller;,citation_author=Stephan Milton Bache;,citation_author=Kirill Müller;,citation_author=Jeroen Ooms;,citation_author=David Robinson;,citation_author=Dana Paige Seidel;,citation_author=Vitalie Spinu;,citation_author=Kohske Takahashi;,citation_author=Davis Vaughan;,citation_author=Claus Wilke;,citation_author=Kara Woo;,citation_author=Hiroaki Yutani;,citation_publication_date=2019;,citation_cover_date=2019;,citation_year=2019;,citation_issue=43;,citation_doi=10.21105/joss.01686;,citation_volume=4;,citation_journal_title=Journal of Open Source Software;">
<meta name="citation_reference" content="citation_title=Paletteer: Comprehensive collection of color palettes;,citation_author=Emil Hvitfeldt;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://github.com/EmilHvitfeldt/paletteer;">
<meta name="citation_reference" content="citation_title=Gapminder: Data from gapminder;,citation_author=Jennifer Bryan;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://CRAN.R-project.org/package=gapminder;">
<meta name="citation_reference" content="citation_title=mlr3: A modern object-oriented machine learning framework in R;,citation_author=Michel Lang;,citation_author=Martin Binder;,citation_author=Jakob Richter;,citation_author=Patrick Schratz;,citation_author=Florian Pfisterer;,citation_author=Stefan Coors;,citation_author=Quay Au;,citation_author=Giuseppe Casalicchio;,citation_author=Lars Kotthoff;,citation_author=Bernd Bischl;,citation_publication_date=2019-12;,citation_cover_date=2019-12;,citation_year=2019;,citation_fulltext_html_url=https://joss.theoj.org/papers/10.21105/joss.01903;,citation_doi=10.21105/joss.01903;,citation_journal_title=Journal of Open Source Software;">
<meta name="citation_reference" content="citation_title=Applied machine learning using mlr3 in R;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com;,citation_isbn=9781032507545;">
<meta name="citation_reference" content="citation_title=Data and basic modeling;,citation_author=Natalie Foss;,citation_author=Lars Kotthoff;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com/data_and_basic_modeling.html;,citation_inbook_title=Applied machine learning using mlr3 in R;">
<meta name="citation_reference" content="citation_title=Factors associated with short-and long-term liver graft survival in the united kingdom: Development of a UK donor liver index;,citation_author=David Collett;,citation_author=Peter J Friend;,citation_author=Christopher JE Watson;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;,citation_issue=4;,citation_volume=101;,citation_journal_title=Transplantation;,citation_publisher=LWW;">
<meta name="citation_reference" content="citation_title=Regression modeling strategies: With applications to linear models, logistic regression, and survival analysis;,citation_author=Frank E Harrell;,citation_author=others;,citation_publication_date=2001;,citation_cover_date=2001;,citation_year=2001;,citation_volume=608;">
<meta name="citation_reference" content="citation_title=Estimating the residual variance in orthogonal regression with variable selection;,citation_author=JB Copas;,citation_author=Tianyong Long;,citation_publication_date=1991;,citation_cover_date=1991;,citation_year=1991;,citation_issue=1;,citation_volume=40;,citation_journal_title=Journal of the Royal Statistical Society Series D: The Statistician;,citation_publisher=Oxford University Press;">
<meta name="citation_reference" content="citation_title=Backward, forward and stepwise automated subset selection algorithms: Frequency of obtaining authentic and noise variables;,citation_author=Shelley Derksen;,citation_author=Harvey J Keselman;,citation_publication_date=1992;,citation_cover_date=1992;,citation_year=1992;,citation_issue=2;,citation_volume=45;,citation_journal_title=British Journal of Mathematical and Statistical Psychology;,citation_publisher=Wiley Online Library;">
<meta name="citation_reference" content="citation_title=Evaluation of clinical prediction models (part 1): From development to external validation;,citation_author=Gary S Collins;,citation_author=Paula Dhiman;,citation_author=Jie Ma;,citation_author=Michael M Schlussel;,citation_author=Lucinda Archer;,citation_author=Ben Van Calster;,citation_author=Frank E Harrell;,citation_author=Glen P Martin;,citation_author=Karel GM Moons;,citation_author=Maarten Van Smeden;,citation_author=others;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_volume=384;,citation_journal_title=Bmj;,citation_publisher=British Medical Journal Publishing Group;">
<meta name="citation_reference" content="citation_title=Validation in prediction research: The waste by data splitting;,citation_author=Ewout W Steyerberg;,citation_publication_date=2018;,citation_cover_date=2018;,citation_year=2018;,citation_volume=103;,citation_journal_title=Journal of clinical epidemiology;,citation_publisher=Elsevier;">
<meta name="citation_reference" content="citation_title=Regression shrinkage and selection via the lasso;,citation_author=Robert Tibshirani;,citation_publication_date=1996;,citation_cover_date=1996;,citation_year=1996;,citation_issue=1;,citation_volume=58;,citation_journal_title=Journal of the Royal Statistical Society Series B: Statistical Methodology;,citation_publisher=Oxford University Press;">
<meta name="citation_reference" content="citation_title=A package for survival analysis in r;,citation_author=Terry M Therneau;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://CRAN.R-project.org/package=survival;">
<meta name="citation_reference" content="citation_title=Data.table: Extension of ‘data.frame‘;,citation_author=Tyson Barrett;,citation_author=Matt Dowle;,citation_author=Arun Srinivasan;,citation_author=Jan Gorecki;,citation_author=Michael Chirico;,citation_author=Toby Hocking;,citation_author=Benjamin Schwendinger;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://CRAN.R-project.org/package=data.table;">
<meta name="citation_reference" content="citation_title=Evaluation and benchmarking;,citation_author=Giuseppe Casalicchio;,citation_author=Lukas Burk;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com/evaluation_and_benchmarking.html;,citation_inbook_title=Applied machine learning using mlr3 in R;">
<meta name="citation_reference" content="citation_title=mlr3data: Collection of machine learning data sets for ’mlr3’;,citation_author=Marc Becker;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://github.com/mlr-org/mlr3data;">
<meta name="citation_reference" content="citation_title=mlr3measures: Performance measures for ’mlr3’;,citation_author=Michel Lang;,citation_author=Marc Becker;,citation_author=Lona Koers;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://CRAN.R-project.org/package=mlr3measures;">
<meta name="citation_reference" content="citation_title=Hyperparameter optimization;,citation_author=Marc Becker;,citation_author=Lennart Schneider;,citation_author=Sebastian Fischer;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com/hyperparameter_optimization.html;,citation_inbook_title=Applied machine learning using mlr3 in R;">
<meta name="citation_reference" content="citation_title=State of the art in selection of variables and functional forms in multivariable analysis—outstanding issues;,citation_author=Willi Sauerbrei;,citation_author=Aris Perperoglou;,citation_author=Matthias Schmid;,citation_author=Michal Abrahamowicz;,citation_author=Heiko Becher;,citation_author=Harald Binder;,citation_author=Daniela Dunkler;,citation_author=Frank E Harrell;,citation_author=Patrick Royston;,citation_author=Georg Heinze;,citation_author=others;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_volume=4;,citation_journal_title=Diagnostic and prognostic research;,citation_publisher=Springer;">
</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Paul Smith</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://pws3141.github.io"> <i class="bi bi-house" role="img">
</i> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pws3141/blog"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Getting Started with {mlr3}</h1>
            <p class="subtitle lead">02 Evaluation and Benchmarking</p>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">r</div>
                <div class="quarto-category">machine learning</div>
                <div class="quarto-category">mlr3</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Paul Smith </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 17, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#question-1" id="toc-question-1" class="nav-link" data-scroll-target="#question-1">Question 1</a>
  <ul class="collapse">
  <li><a href="#answer" id="toc-answer" class="nav-link" data-scroll-target="#answer">Answer</a></li>
  </ul></li>
  <li><a href="#question-2" id="toc-question-2" class="nav-link" data-scroll-target="#question-2">Question 2</a>
  <ul class="collapse">
  <li><a href="#answer-1" id="toc-answer-1" class="nav-link" data-scroll-target="#answer-1">Answer</a></li>
  </ul></li>
  <li><a href="#question-3" id="toc-question-3" class="nav-link" data-scroll-target="#question-3">Question 3</a>
  <ul class="collapse">
  <li><a href="#answer-2" id="toc-answer-2" class="nav-link" data-scroll-target="#answer-2">Answer</a></li>
  </ul></li>
  <li><a href="#question-4" id="toc-question-4" class="nav-link" data-scroll-target="#question-4">Question 4</a>
  <ul class="collapse">
  <li><a href="#answer-3" id="toc-answer-3" class="nav-link" data-scroll-target="#answer-3">Answer</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<section id="introduction" class="level1 page-columns page-full">
<h1>Introduction</h1>
<p>I am attempting to learn how to use <code>{mlr3}</code> <span class="citation" data-cites="lang2019mlr3">(<a href="#ref-lang2019mlr3" role="doc-biblioref">Lang et al. 2019</a>)</span>, by reading through the book <a href="https://mlr3book.mlr-org.com/">Applied Machine Learning Using mlr3 in R</a> <span class="citation" data-cites="bischl2024usingmlr3">(<a href="#ref-bischl2024usingmlr3" role="doc-biblioref">Bischl et al. 2024</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-lang2019mlr3" class="csl-entry" role="listitem">
Lang, Michel, Martin Binder, Jakob Richter, Patrick Schratz, Florian Pfisterer, Stefan Coors, Quay Au, Giuseppe Casalicchio, Lars Kotthoff, and Bernd Bischl. 2019. <span>“<span class="nocase">mlr3</span>: A Modern Object-Oriented Machine Learning Framework in <span>R</span>.”</span> <em>Journal of Open Source Software</em>, December. <a href="https://doi.org/10.21105/joss.01903">https://doi.org/10.21105/joss.01903</a>.
</div><div id="ref-bischl2024usingmlr3" class="csl-entry" role="listitem">
Bischl, Bernd, Raphael Sonabend, Lars Kotthoff, and Michel Lang, eds. 2024. <em>Applied Machine Learning Using <span class="nocase">m</span>lr3 in <span>R</span></em>. CRC Press. <a href="https://mlr3book.mlr-org.com">https://mlr3book.mlr-org.com</a>.
</div></div><p>My previous posts include:</p>
<ul>
<li><a href="../../posts/05-mlr3_basic_modelling/index.html">Part one</a>:
<ul>
<li>Create a classification tree model to predict diabetes.</li>
<li>Look at the confusion matrix and create measures without using {mlr3measures}.</li>
<li>Change the thresholds in the model.</li>
</ul></li>
</ul>
<p>In this second blog post, I am going through the exercises given in Section 3 <span class="citation" data-cites="casalicchio2024evaluation">(<a href="#ref-casalicchio2024evaluation" role="doc-biblioref">Casalicchio and Burk 2024</a>)</span>. This involves using repeated cross-validation resampling, using a custom resampling strategy, and creating a function that produces a ROC.</p>
<div class="no-row-height column-margin column-container"><div id="ref-casalicchio2024evaluation" class="csl-entry" role="listitem">
Casalicchio, Giuseppe, and Lukas Burk. 2024. <span>“Evaluation and Benchmarking.”</span> In <em>Applied Machine Learning Using <span class="nocase">m</span>lr3 in <span>R</span></em>, edited by Bernd Bischl, Raphael Sonabend, Lars Kotthoff, and Michel Lang. CRC Press. <a href="https://mlr3book.mlr-org.com/evaluation_and_benchmarking.html">https://mlr3book.mlr-org.com/evaluation_and_benchmarking.html</a>.
</div></div><section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3viz)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3data)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.nrows =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercises" class="level1 page-columns page-full">
<h1>Exercises</h1>
<ol type="1">
<li>Apply a repeated cross-validation resampling strategy on <code>tsk("mtcars")</code> and evaluate the performance of <code>lrn("regr.rpart")</code>.
<ul>
<li>Use five repeats of three folds each.</li>
<li>Calculate the MSE for each iteration and visualize the result.</li>
<li>Finally, calculate the aggregated performance score.</li>
</ul></li>
<li>Use <code>tsk("spam")</code> and five-fold CV to benchmark <code>lrn("classif.ranger")</code>, <code>lrn("classif.log_reg")</code>, and <code>lrn("classif.xgboost", nrounds = 100)</code> with respect to AUC.
<ul>
<li>Which learner appears to perform best?</li>
<li>How confident are you in your conclusion?</li>
<li>Think about the stability of results and investigate this by re-running the experiment with different seeds.</li>
<li>What can be done to improve this?</li>
</ul></li>
<li>A colleague reports a 93.1% classification accuracy using <code>lrn("classif.rpart")</code> on <code>tsk("penguins_simple")</code>.
<ul>
<li>You want to reproduce their results and ask them about their resampling strategy.</li>
<li>They said they used a custom three-fold CV with folds assigned as <code>factor(task$row_ids %% 3)</code>.</li>
<li>See if you can reproduce their results.</li>
</ul></li>
<li>(*) Program your own ROC plotting function <strong>without</strong> using <code>mlr3</code>’s <code>autoplot()</code> function.
<ul>
<li>The signature of your function should be <code>my_roc_plot(task, learner, train_indices, test_indices)</code>.</li>
<li>Your function should use the <code>$set_threshold()</code> method of <code>Prediction</code>, as well as <code>mlr3measures</code>.</li>
</ul></li>
</ol>
<p>First, let’s suppress all messaging unless it’s a warning:<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;See <a href="https://mlr3book.mlr-org.com/chapters/chapter10/advanced_technical_aspects_of_mlr3.html#sec-logging">Section 10.3</a> of the tutorial for more information about mlr3 logging output)</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="question-1" class="level2">
<h2 class="anchored" data-anchor-id="question-1">Question 1</h2>
<p>Apply a repeated cross-validation resampling strategy on <code>tsk("mtcars")</code> and evaluate the performance of <code>lrn("regr.rpart")</code>.</p>
<ul>
<li>Use five repeats of three folds each.</li>
<li>Calculate the MSE for each iteration and visualize the result.</li>
<li>Finally, calculate the aggregated performance score.</li>
</ul>
<section id="answer" class="level3">
<h3 class="anchored" data-anchor-id="answer">Answer</h3>
<p>First, I’ll load the <code>Task</code>, <code>Learner</code>, and create the <code>rsmp()</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tsk_mtcars <span class="ot">&lt;-</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>tsk_mtcars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:mtcars&gt; (32 x 11): Motor Trends
* Target: mpg
* Properties: -
* Features (10):
  - dbl (10): am, carb, cyl, disp, drat, gear, hp, qsec, vs, wt</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load learner</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lrn_rpart <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>lrn_rpart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;LearnerRegrRpart:regr.rpart&gt;: Regression Tree
* Model: -
* Parameters: xval=0
* Packages: mlr3, rpart
* Predict Types:  [response]
* Feature Types: logical, integer, numeric, factor, ordered
* Properties: importance, missings, selected_features, weights</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load resampling method: 5 lots of three-fold CV</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>rcv53 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">5</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>rcv53</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResamplingRepeatedCV&gt;: Repeated Cross-Validation
* Iterations: 15
* Instantiated: FALSE
* Parameters: folds=3, repeats=5</code></pre>
</div>
</div>
<p>Now, I’ll use the <code>resample()</code> function to run the resampling strategy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">&lt;-</span> <span class="fu">resample</span>(tsk_mtcars, lrn_rpart, rcv53)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>rr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResampleResult&gt; with 15 resampling iterations
 task_id learner_id resampling_id iteration  prediction_test warnings errors
  mtcars regr.rpart   repeated_cv         1 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         2 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         3 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         4 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         5 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         6 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         7 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         8 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv         9 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv        10 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv        11 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv        12 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv        13 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv        14 &lt;PredictionRegr&gt;        0      0
  mtcars regr.rpart   repeated_cv        15 &lt;PredictionRegr&gt;        0      0</code></pre>
</div>
</div>
<p>Calculating the MSE for each iteration requires running <code>$score()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>rr_mse <span class="ot">&lt;-</span> rr<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>rr_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    task_id learner_id resampling_id iteration  regr.mse
     &lt;char&gt;     &lt;char&gt;        &lt;char&gt;     &lt;int&gt;     &lt;num&gt;
 1:  mtcars regr.rpart   repeated_cv         1 14.547959
 2:  mtcars regr.rpart   repeated_cv         2 20.500724
 3:  mtcars regr.rpart   repeated_cv         3 12.901045
 4:  mtcars regr.rpart   repeated_cv         4 17.847028
 5:  mtcars regr.rpart   repeated_cv         5 13.558418
 6:  mtcars regr.rpart   repeated_cv         6 13.856750
 7:  mtcars regr.rpart   repeated_cv         7 22.489190
 8:  mtcars regr.rpart   repeated_cv         8 19.020020
 9:  mtcars regr.rpart   repeated_cv         9  9.775333
10:  mtcars regr.rpart   repeated_cv        10 31.090450
11:  mtcars regr.rpart   repeated_cv        11 20.193302
12:  mtcars regr.rpart   repeated_cv        12 33.121017
13:  mtcars regr.rpart   repeated_cv        13 27.174212
14:  mtcars regr.rpart   repeated_cv        14 29.727324
15:  mtcars regr.rpart   repeated_cv        15  8.674896
Hidden columns: task, learner, resampling, prediction_test</code></pre>
</div>
</div>
<p>Let’s plot this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rr, <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>), <span class="at">type =</span> <span class="st">"boxplot"</span>) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rr, <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>), <span class="at">type =</span> <span class="st">"histogram"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Aggregating the MSE scores (using <em>macro</em> aggregation) gives:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
19.63184 </code></pre>
</div>
</div>
</section>
</section>
<section id="question-2" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="question-2">Question 2</h2>
<p>Use <code>tsk("spam")</code> and five-fold CV to benchmark <code>lrn("classif.ranger")</code>, <code>lrn("classif.log_reg")</code>, and <code>lrn("classif.xgboost", nrounds = 100)</code> with respect to AUC.</p>
<ul>
<li>Which learner appears to perform best?</li>
<li>How confident are you in your conclusion?</li>
<li>Think about the stability of results and investigate this by re-running the experiment with different seeds.</li>
<li>What can be done to improve this?</li>
</ul>
<section id="answer-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="answer-1">Answer</h3>
<p>Let’s load the task, learners and resampling method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tsk_spam <span class="ot">&lt;-</span> <span class="fu">tsk</span>(<span class="st">"spam"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>tsk_spam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:spam&gt; (4601 x 58): HP Spam Detection
* Target: type
* Properties: twoclass
* Features (57):
  - dbl (57): address, addresses, all, business, capitalAve,
    capitalLong, capitalTotal, charDollar, charExclamation, charHash,
    charRoundbracket, charSemicolon, charSquarebracket, conference,
    credit, cs, data, direct, edu, email, font, free, george, hp, hpl,
    internet, lab, labs, mail, make, meeting, money, num000, num1999,
    num3d, num415, num650, num85, num857, order, original, our, over,
    parts, people, pm, project, re, receive, remove, report, table,
    technology, telnet, will, you, your</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up leaners</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># first set up the 'lrns()' then modify the xgboost 'nrounds' argument</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">&lt;-</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"classif.ranger"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.xgboost"</span>), </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust 'nrounds' argument for xgboost</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>learners<span class="sc">$</span>classif.xgboost<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>nrounds <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>learners</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.ranger
&lt;LearnerClassifRanger:classif.ranger&gt;: Random Forest
* Model: -
* Parameters: num.threads=1
* Packages: mlr3, mlr3learners, ranger
* Predict Types:  response, [prob]
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: hotstart_backward, importance, missings, multiclass,
  oob_error, selected_features, twoclass, weights

$classif.log_reg
&lt;LearnerClassifLogReg:classif.log_reg&gt;: Logistic Regression
* Model: -
* Parameters: use_pred_offset=TRUE
* Packages: mlr3, mlr3learners, stats
* Predict Types:  response, [prob]
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: offset, twoclass, weights

$classif.xgboost
&lt;LearnerClassifXgboost:classif.xgboost&gt;: Extreme Gradient Boosting
* Model: -
* Parameters: nrounds=100, nthread=1, verbose=0
* Validate: NULL
* Packages: mlr3, mlr3learners, xgboost
* Predict Types:  response, [prob]
* Feature Types: logical, integer, numeric
* Properties: hotstart_forward, importance, internal_tuning, missings,
  multiclass, offset, twoclass, validation, weights</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up resampling</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cv5 <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>cv5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResamplingCV&gt;: Cross-Validation
* Iterations: 5
* Instantiated: FALSE
* Parameters: folds=5</code></pre>
</div>
</div>
<p>Now we can set up the benchmark grid.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="fu">benchmark_grid</span>(tsk_spam, learners, cv5)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>design</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     task         learner resampling
   &lt;char&gt;          &lt;char&gt;     &lt;char&gt;
1:   spam  classif.ranger         cv
2:   spam classif.log_reg         cv
3:   spam classif.xgboost         cv</code></pre>
</div>
</div>
<p>Now, see how well these perform in terms of AUC.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;<strong>Recall:</strong> AUC can be interpreted as the probability that a randomly chosen positive instance has a higher predicted probability of belonging to the positive class than a randomly chosen negative instance</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.auc"</span>))[, .(learner_id, iteration, classif.auc)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         learner_id iteration classif.auc
             &lt;char&gt;     &lt;int&gt;       &lt;num&gt;
 1:  classif.ranger         1   0.9905328
 2:  classif.ranger         2   0.9807452
 3:  classif.ranger         3   0.9861848
 4:  classif.ranger         4   0.9818771
 5:  classif.ranger         5   0.9914047
 6: classif.log_reg         1   0.9729649
 7: classif.log_reg         2   0.9604636
 8: classif.log_reg         3   0.9831002
 9: classif.log_reg         4   0.9646964
10: classif.log_reg         5   0.9757900
11: classif.xgboost         1   0.9896168
12: classif.xgboost         2   0.9844034
13: classif.xgboost         3   0.9909272
14: classif.xgboost         4   0.9853751
15: classif.xgboost         5   0.9919197</code></pre>
</div>
</div>
<p>And let’s aggregate by <code>Learner</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.auc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      nr task_id      learner_id resampling_id iters classif.auc
   &lt;int&gt;  &lt;char&gt;          &lt;char&gt;        &lt;char&gt; &lt;int&gt;       &lt;num&gt;
1:     1    spam  classif.ranger            cv     5   0.9861489
2:     2    spam classif.log_reg            cv     5   0.9714030
3:     3    spam classif.xgboost            cv     5   0.9884484
Hidden columns: resample_result</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.auc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, from a naive look at this, it appears that the XGBoost model performs the best (highest AUC). However, the results from all three of these models appear very similar, and I would maybe prefer “simpler” models over more flexible ones in this case (here, the logistic regression model).</p>
<p>If we run this 5 times with different seeds, let’s see how the AUC varies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>bmr_auc <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="dv">5</span>), <span class="cf">function</span>(i) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                         tmp_seed <span class="ot">&lt;-</span> i <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">set.seed</span>(tmp_seed)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                         design <span class="ot">&lt;-</span> <span class="fu">benchmark_grid</span>(tsk_spam, learners, cv5)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                         bmr <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">data.table</span>(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">seed =</span> tmp_seed,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">auc =</span> bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.auc"</span>))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                                       )</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>bmr_auc[, .(seed, auc.learner_id, auc.classif.auc)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     seed  auc.learner_id auc.classif.auc
    &lt;num&gt;          &lt;char&gt;           &lt;num&gt;
 1:   100  classif.ranger       0.9866242
 2:   100 classif.log_reg       0.9708618
 3:   100 classif.xgboost       0.9883961
 4:   200  classif.ranger       0.9864776
 5:   200 classif.log_reg       0.9705954
 6:   200 classif.xgboost       0.9879994
 7:   300  classif.ranger       0.9855379
 8:   300 classif.log_reg       0.9710461
 9:   300 classif.xgboost       0.9878387
10:   400  classif.ranger       0.9866107
11:   400 classif.log_reg       0.9697749
12:   400 classif.xgboost       0.9888800
13:   500  classif.ranger       0.9862768
14:   500 classif.log_reg       0.9702488
15:   500 classif.xgboost       0.9879613</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># some summary stats</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>bmr_auc[, <span class="fu">as.list</span>(<span class="fu">summary</span>(auc.classif.auc)), by <span class="ot">=</span> auc.learner_id]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    auc.learner_id      Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
            &lt;char&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;
1:  classif.ranger 0.9855379 0.9862768 0.9864776 0.9863055 0.9866107 0.9866242
2: classif.log_reg 0.9697749 0.9702488 0.9705954 0.9705054 0.9708618 0.9710461
3: classif.xgboost 0.9878387 0.9879613 0.9879994 0.9882151 0.9883961 0.9888800</code></pre>
</div>
</div>
<p>Although XGBoost achieved the highest AUC on average, the difference compared to ranger was minimal across repeated runs (although XGBoost always very slighly outperforms the random forest model, after aggregation). Confidence intervals or additional repeats could provide better insight into whether the observed difference is meaningful. The choice of model will depend on how important that small difference is in the AUC compared to model complexity.</p>
</section>
</section>
<section id="question-3" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="question-3">Question 3</h2>
<p>A colleague reports a <span class="math inline">\(93.1\%\)</span> classification accuracy using <code>lrn("classif.rpart")</code> on <code>tsk("penguins_simple")</code>.</p>
<ul>
<li>You want to reproduce their results and ask them about their resampling strategy.</li>
<li>They said they used a custom three-fold CV with folds assigned as <code>factor(task$row_ids %% 3)</code>.</li>
<li>See if you can reproduce their results.</li>
</ul>
<section id="answer-2" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="answer-2">Answer</h3>
<p>Let’s have a look at the <code>Task</code>. This task doesn’t seem to be in included in the default {mlr3} package, but is referenced in the {mlr3data} <span class="citation" data-cites="becker2024mlr3data">(<a href="#ref-becker2024mlr3data" role="doc-biblioref">Becker 2024</a>)</span> <a href="https://mlr3data.mlr-org.com/reference/penguins_simple.html">docs</a>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-becker2024mlr3data" class="csl-entry" role="listitem">
Becker, Marc. 2024. <em>Mlr3data: Collection of Machine Learning Data Sets for ’Mlr3’</em>. <a href="https://github.com/mlr-org/mlr3data">https://github.com/mlr-org/mlr3data</a>.
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>tsk_penguins <span class="ot">&lt;-</span> <span class="fu">tsk</span>(<span class="st">"penguins_simple"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>tsk_penguins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:penguins&gt; (333 x 11): Simplified Palmer Penguins
* Target: species
* Properties: multiclass
* Features (10):
  - dbl (7): bill_depth, bill_length, island.Biscoe, island.Dream,
    island.Torgersen, sex.female, sex.male
  - int (3): body_mass, flipper_length, year</code></pre>
</div>
</div>
<p>OK, so this is a multi-class classification task, using 10 features to predict the species of the penguin.</p>
<p>They said they used a custom three-fold CV, so let’s try and reproduce this. By looking at <code>factor(tsk_penguins$row_ids %% 3)</code>, we can see that the CV is putting every third observation into the same fold. This feels weird and wrong, but fine.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp; This folding strategy does not ensure class balance within each fold and may lead to biased performance estimates, particularly in smaller datasets.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load learner</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>lrn_rpart <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>lrn_rpart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;LearnerClassifRpart:classif.rpart&gt;: Classification Tree
* Model: -
* Parameters: xval=0
* Packages: mlr3, rpart
* Predict Types:  [response], prob
* Feature Types: logical, integer, numeric, factor, ordered
* Properties: importance, missings, multiclass, selected_features,
  twoclass, weights</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create custom resampling strategy</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>rsmp_custom <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"custom_cv"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">factor</span>(tsk_penguins<span class="sc">$</span>row_ids <span class="sc">%%</span> <span class="dv">3</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>rsmp_custom<span class="sc">$</span><span class="fu">instantiate</span>(tsk_penguins, <span class="at">f =</span> folds)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">&lt;-</span> <span class="fu">resample</span>(tsk_penguins, lrn_rpart, rsmp_custom)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">predictions</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
&lt;PredictionClassif&gt; for 111 observations:
 row_ids     truth  response
       3    Adelie    Adelie
       6    Adelie    Adelie
       9    Adelie    Adelie
     ---       ---       ---
     327 Chinstrap Chinstrap
     330 Chinstrap    Adelie
     333 Chinstrap Chinstrap

[[2]]
&lt;PredictionClassif&gt; for 111 observations:
 row_ids     truth  response
       1    Adelie    Adelie
       4    Adelie    Adelie
       7    Adelie    Adelie
     ---       ---       ---
     325 Chinstrap Chinstrap
     328 Chinstrap Chinstrap
     331 Chinstrap Chinstrap

[[3]]
&lt;PredictionClassif&gt; for 111 observations:
 row_ids     truth response
       2    Adelie   Adelie
       5    Adelie   Adelie
       8    Adelie   Adelie
     ---       ---      ---
     326 Chinstrap   Gentoo
     329 Chinstrap   Gentoo
     332 Chinstrap   Gentoo</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    task_id    learner_id resampling_id iteration classif.acc
     &lt;char&gt;        &lt;char&gt;        &lt;char&gt;     &lt;int&gt;       &lt;num&gt;
1: penguins classif.rpart     custom_cv         1   0.9369369
2: penguins classif.rpart     custom_cv         2   0.9189189
3: penguins classif.rpart     custom_cv         3   0.9369369
Hidden columns: task, learner, resampling, prediction_test</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.acc 
  0.9309309 </code></pre>
</div>
</div>
<p>So, we get a model with <span class="math inline">\(93.1\%\)</span> accuracy, as required.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Would the results change much with, for example, <a href="https://mlr3book.mlr-org.com/chapters/chapter3/evaluation_and_benchmarking.html#sec-strat-group">grouped resampling</a>? I should look at this at some point.</p></div></div></section>
</section>
<section id="question-4" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="question-4">Question 4</h2>
<p>(*) Program your own ROC plotting function <strong>without</strong> using <code>mlr3</code>’s <code>autoplot()</code> function.</p>
<ul>
<li>The signature of your function should be <code>my_roc_plot(task, learner, train_indices, test_indices)</code>.</li>
<li>Your function should use the <code>$set_threshold()</code> method of <code>Prediction</code>, as well as <code>mlr3measures</code>.</li>
</ul>
<section id="answer-3" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="answer-3">Answer</h3>
<p>Let’s first have a look at the output from using <code>autoplot()</code>. I’ll use the <code>german_credit</code> task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>tsk_german <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"german_credit"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>tsk_german</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:german_credit&gt; (1000 x 21): German Credit
* Target: credit_risk
* Properties: twoclass
* Features (20):
  - fct (14): credit_history, employment_duration, foreign_worker,
    housing, job, other_debtors, other_installment_plans,
    people_liable, personal_status_sex, property, purpose, savings,
    status, telephone
  - int (3): age, amount, duration
  - ord (3): installment_rate, number_credits, present_residence</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>lrn_ranger <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>splits <span class="ot">=</span> <span class="fu">partition</span>(tsk_german, <span class="at">ratio =</span> <span class="fl">0.8</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>lrn_ranger<span class="sc">$</span><span class="fu">train</span>(tsk_german, splits<span class="sc">$</span>train)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> lrn_ranger<span class="sc">$</span><span class="fu">predict</span>(tsk_german, splits<span class="sc">$</span>test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(prediction, <span class="at">type =</span> <span class="st">"roc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>First, I’ll do all the steps to create the ROC, then I’ll wrap this in a function, <code>my_roc_plot()</code>.</p>
<section id="creating-the-roc" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="creating-the-roc">Creating the ROC</h4>
<p>OK – so I need to use <a href="https://mlr3.mlr-org.com/reference/PredictionClassif.html#method-PredictionClassif-set_threshold"><code>$set_threshold()</code></a> to obtain predictions over the range of thresholds. Then, I need to use {mlr3measures} <span class="citation" data-cites="lang2024mlr3measures">(<a href="#ref-lang2024mlr3measures" role="doc-biblioref">Lang, Becker, and Koers 2024</a>)</span> to compute the TPR (Sensitivity) and FPR (<span class="math inline">\(1 -\)</span> Specificity) and plot these all on a lovely graph.</p>
<div class="no-row-height column-margin column-container"><div id="ref-lang2024mlr3measures" class="csl-entry" role="listitem">
Lang, Michel, Marc Becker, and Lona Koers. 2024. <em>Mlr3measures: Performance Measures for ’Mlr3’</em>. <a href="https://CRAN.R-project.org/package=mlr3measures">https://CRAN.R-project.org/package=mlr3measures</a>.
</div><div class="">
<dl>
<dt>Sensitivity</dt>
<dd>
(true positive rate) is the probability of a positive test result, conditioned on the individual truly being positive.
</dd>
<dt>Specificity</dt>
<dd>
(true negative rate) is the probability of a negative test result, conditioned on the individual truly being negative.
</dd>
</dl>
</div></div>
<p>I’ll first check to see which is the <code>positive</code> outcome in the <code>Task</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>tsk_german<span class="sc">$</span>positive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "good"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># also, by looking at the help file 'prediction$help()'</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># can see that the positive class is the first level of '$truth', i.e.</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(prediction<span class="sc">$</span>truth)[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "good"</code></pre>
</div>
</div>
<p>So having <code>good</code> credit is the positive outcome here.</p>
<p>Now, I’ll create a vector of thresholds<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> and then obtain predictions and calculate the measures.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Thresholds were discussed in <a href="https://mlr3book.mlr-org.com/chapters/chapter2/data_and_basic_modeling.html#sec-classif-prediction">Section 2.5.4</a> of the mlr3 tutorial, and I looked at them in Question 3 of my <a href="../../posts/05-mlr3_basic_modelling/index.html">previous post</a></p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>positive_class <span class="ot">&lt;-</span> <span class="fu">levels</span>(prediction<span class="sc">$</span>truth)[<span class="dv">1</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>thresholds <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">101</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>tsk_german_measures <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">lapply</span>(thresholds, <span class="cf">function</span>(j) {</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                prediction<span class="sc">$</span><span class="fu">set_threshold</span>(j)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                tpr_tmp <span class="ot">&lt;-</span> mlr3measures<span class="sc">::</span><span class="fu">tpr</span>(<span class="at">truth =</span> prediction<span class="sc">$</span>truth,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">response =</span> prediction<span class="sc">$</span>response,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">positive =</span> positive_class)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>                fpr_tmp <span class="ot">&lt;-</span> mlr3measures<span class="sc">::</span><span class="fu">fpr</span>(<span class="at">truth =</span> prediction<span class="sc">$</span>truth,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">response =</span> prediction<span class="sc">$</span>response,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">positive =</span> positive_class)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">data.table</span>(<span class="at">threshold =</span> j,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">tpr =</span> tpr_tmp,</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fpr =</span> fpr_tmp)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="co"># order by increasing fpr, and tpr</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co"># s.t. the step function avoids spikes</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co"># spikes are happening as seed not set in $set_threshold(),</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co"># so possible to get non-monotonic tpr/ fpr</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="co"># also put them in descending threshold order, just to make the data look nicer.</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>tsk_german_measures <span class="ot">&lt;-</span> tsk_german_measures[<span class="fu">order</span>(fpr, tpr, <span class="sc">-</span>threshold)]</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>tsk_german_measures</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     threshold         tpr   fpr
         &lt;num&gt;       &lt;num&gt; &lt;num&gt;
  1:      1.00 0.000000000     0
  2:      0.99 0.000000000     0
  3:      0.98 0.006896552     0
  4:      0.97 0.013793103     0
  5:      0.96 0.013793103     0
 ---                            
 97:      0.04 1.000000000     1
 98:      0.03 1.000000000     1
 99:      0.02 1.000000000     1
100:      0.01 1.000000000     1
101:      0.00 1.000000000     1</code></pre>
</div>
</div>
<p>OK, I think I’ve got everything required to plot the ROC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tsk_german_measures, <span class="fu">aes</span>(<span class="at">x =</span> fpr, <span class="at">y =</span> tpr)) <span class="sc">+</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">colour =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"1 - Specificity"</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="st">"Sensitivity"</span>) <span class="sc">+</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="making-the-function-my_roc_plot" class="level4">
<h4 class="anchored" data-anchor-id="making-the-function-my_roc_plot">Making the function <code>my_roc_plot()</code></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>my_roc_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(task, learner, train_indices, test_indices) {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>        <span class="co"># task: a 'Task' object</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># learner: a 'Learner' object</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># train the learner on the task</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        learner<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> train_indices)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create the prediction object</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>        prediction <span class="ot">&lt;-</span> learner<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> test_indices)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># find TPR and FPR over a seq of thresholds</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        positive_class <span class="ot">&lt;-</span> <span class="fu">levels</span>(prediction<span class="sc">$</span>truth)[<span class="dv">1</span>]</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        thresholds <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">101</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        tpr_fpr_thresholds <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">lapply</span>(thresholds, <span class="cf">function</span>(j) {</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                        prediction<span class="sc">$</span><span class="fu">set_threshold</span>(j)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                        tpr_tmp <span class="ot">&lt;-</span> mlr3measures<span class="sc">::</span><span class="fu">tpr</span>(<span class="at">truth =</span> prediction<span class="sc">$</span>truth,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">response =</span> prediction<span class="sc">$</span>response,</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">positive =</span> positive_class)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                        fpr_tmp <span class="ot">&lt;-</span> mlr3measures<span class="sc">::</span><span class="fu">fpr</span>(<span class="at">truth =</span> prediction<span class="sc">$</span>truth,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">response =</span> prediction<span class="sc">$</span>response,</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">positive =</span> positive_class)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">data.table</span>(<span class="at">threshold =</span> j,</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">tpr =</span> tpr_tmp,</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">fpr =</span> fpr_tmp)</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        tpr_fpr_thresholds <span class="ot">&lt;-</span> tpr_fpr_thresholds[<span class="fu">order</span>(fpr, tpr, <span class="sc">-</span>threshold)]</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and plot</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(tpr_fpr_thresholds, <span class="fu">aes</span>(<span class="at">x =</span> fpr, <span class="at">y =</span> tpr)) <span class="sc">+</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>                <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>                <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>,</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>                            <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">colour =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>                <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"1 - Specificity"</span>,</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>                     <span class="at">y =</span> <span class="st">"Sensitivity"</span>) <span class="sc">+</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_minimal</span>()</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">my_roc_plot</span>(<span class="at">task =</span> tsk_german,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">train_indices =</span> splits<span class="sc">$</span>train,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">test_indices =</span> splits<span class="sc">$</span>test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Cool, looks good!</p>
</section>
</section>
</section>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{smith2025,
  author = {Smith, Paul},
  title = {Getting {Started} with \{Mlr3\}},
  date = {2025-03-17},
  url = {https://pws3141.github.io/blog/posts/08-mlr3_evaluation_benchmarking/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-smith2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Smith, Paul. 2025. <span>“Getting Started with {Mlr3}.”</span> March 17,
2025. <a href="https://pws3141.github.io/blog/posts/08-mlr3_evaluation_benchmarking/">https://pws3141.github.io/blog/posts/08-mlr3_evaluation_benchmarking/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/pws3141\.github\.io\/blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>