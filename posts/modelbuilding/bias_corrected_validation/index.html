<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Paul Smith">
<meta name="dcterms.date" content="2025-04-26">

<title>Model Validation using the Bootstrap – Paul Smith</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-39aa5599c175b676807642dbe23379f8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
<meta name="citation_title" content="Model Validation using the Bootstrap">
<meta name="citation_author" content="Paul Smith">
<meta name="citation_publication_date" content="2025-04-26">
<meta name="citation_cover_date" content="2025-04-26">
<meta name="citation_year" content="2025">
<meta name="citation_online_date" content="2025-04-26">
<meta name="citation_fulltext_html_url" content="https://pws3141.github.io/blog/posts/modelbuilding/bias_corrected_validation/">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Clmnis: An r package for downloading data from the parliamentary members names information service;,citation_author=Noel Dempsey;,citation_publication_date=2025;,citation_cover_date=2025;,citation_year=2025;,citation_fulltext_html_url=https://github.com/houseofcommonslibrary/clmnis;">
<meta name="citation_reference" content="citation_title=Highcharter: A wrapper for the ’highcharts’ library;,citation_author=Joshua Kunst;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_fulltext_html_url=https://CRAN.R-project.org/package=highcharter;">
<meta name="citation_reference" content="citation_title=Palmerpenguins: Palmer archipelago (antarctica) penguin data;,citation_author=Allison Marie Horst;,citation_author=Alison Presmanes Hill;,citation_author=Kristen B Gorman;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_fulltext_html_url=https://allisonhorst.github.io/palmerpenguins/;,citation_doi=10.5281/zenodo.3960218;">
<meta name="citation_reference" content="citation_title=Medicaldata: Data package for medical datasets;,citation_author=Peter Higgins;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://CRAN.R-project.org/package=medicaldata;">
<meta name="citation_reference" content="citation_title=Fontawesome: Easily work with ’font awesome’ icons;,citation_author=Richard Iannone;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://github.com/rstudio/fontawesome;">
<meta name="citation_reference" content="citation_title=Welcome to the tidyverse;,citation_author=Hadley Wickham;,citation_author=Mara Averick;,citation_author=Jennifer Bryan;,citation_author=Winston Chang;,citation_author=Lucy D’Agostino McGowan;,citation_author=Romain François;,citation_author=Garrett Grolemund;,citation_author=Alex Hayes;,citation_author=Lionel Henry;,citation_author=Jim Hester;,citation_author=Max Kuhn;,citation_author=Thomas Lin Pedersen;,citation_author=Evan Miller;,citation_author=Stephan Milton Bache;,citation_author=Kirill Müller;,citation_author=Jeroen Ooms;,citation_author=David Robinson;,citation_author=Dana Paige Seidel;,citation_author=Vitalie Spinu;,citation_author=Kohske Takahashi;,citation_author=Davis Vaughan;,citation_author=Claus Wilke;,citation_author=Kara Woo;,citation_author=Hiroaki Yutani;,citation_publication_date=2019;,citation_cover_date=2019;,citation_year=2019;,citation_issue=43;,citation_doi=10.21105/joss.01686;,citation_volume=4;,citation_journal_title=Journal of Open Source Software;">
<meta name="citation_reference" content="citation_title=Paletteer: Comprehensive collection of color palettes;,citation_author=Emil Hvitfeldt;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://github.com/EmilHvitfeldt/paletteer;">
<meta name="citation_reference" content="citation_title=Gapminder: Data from gapminder;,citation_author=Jennifer Bryan;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://CRAN.R-project.org/package=gapminder;">
<meta name="citation_reference" content="citation_title=mlr3: A modern object-oriented machine learning framework in R;,citation_author=Michel Lang;,citation_author=Martin Binder;,citation_author=Jakob Richter;,citation_author=Patrick Schratz;,citation_author=Florian Pfisterer;,citation_author=Stefan Coors;,citation_author=Quay Au;,citation_author=Giuseppe Casalicchio;,citation_author=Lars Kotthoff;,citation_author=Bernd Bischl;,citation_publication_date=2019-12;,citation_cover_date=2019-12;,citation_year=2019;,citation_fulltext_html_url=https://joss.theoj.org/papers/10.21105/joss.01903;,citation_doi=10.21105/joss.01903;,citation_journal_title=Journal of Open Source Software;">
<meta name="citation_reference" content="citation_title=Applied machine learning using mlr3 in R;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com;,citation_isbn=9781032507545;">
<meta name="citation_reference" content="citation_title=Data and basic modeling;,citation_author=Natalie Foss;,citation_author=Lars Kotthoff;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com/data_and_basic_modeling.html;,citation_inbook_title=Applied machine learning using mlr3 in R;">
<meta name="citation_reference" content="citation_title=Factors associated with short-and long-term liver graft survival in the united kingdom: Development of a UK donor liver index;,citation_author=David Collett;,citation_author=Peter J Friend;,citation_author=Christopher JE Watson;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;,citation_issue=4;,citation_volume=101;,citation_journal_title=Transplantation;,citation_publisher=LWW;">
<meta name="citation_reference" content="citation_title=Regression modeling strategies: With applications to linear models, logistic regression, and survival analysis;,citation_author=Frank E Harrell;,citation_author=others;,citation_publication_date=2001;,citation_cover_date=2001;,citation_year=2001;,citation_volume=608;">
<meta name="citation_reference" content="citation_title=Estimating the residual variance in orthogonal regression with variable selection;,citation_author=JB Copas;,citation_author=Tianyong Long;,citation_publication_date=1991;,citation_cover_date=1991;,citation_year=1991;,citation_issue=1;,citation_volume=40;,citation_journal_title=Journal of the Royal Statistical Society Series D: The Statistician;,citation_publisher=Oxford University Press;">
<meta name="citation_reference" content="citation_title=Backward, forward and stepwise automated subset selection algorithms: Frequency of obtaining authentic and noise variables;,citation_author=Shelley Derksen;,citation_author=Harvey J Keselman;,citation_publication_date=1992;,citation_cover_date=1992;,citation_year=1992;,citation_issue=2;,citation_volume=45;,citation_journal_title=British Journal of Mathematical and Statistical Psychology;,citation_publisher=Wiley Online Library;">
<meta name="citation_reference" content="citation_title=Evaluation of clinical prediction models (part 1): From development to external validation;,citation_author=Gary S Collins;,citation_author=Paula Dhiman;,citation_author=Jie Ma;,citation_author=Michael M Schlussel;,citation_author=Lucinda Archer;,citation_author=Ben Van Calster;,citation_author=Frank E Harrell;,citation_author=Glen P Martin;,citation_author=Karel GM Moons;,citation_author=Maarten Van Smeden;,citation_author=others;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_volume=384;,citation_journal_title=Bmj;,citation_publisher=British Medical Journal Publishing Group;">
<meta name="citation_reference" content="citation_title=Validation in prediction research: The waste by data splitting;,citation_author=Ewout W Steyerberg;,citation_publication_date=2018;,citation_cover_date=2018;,citation_year=2018;,citation_volume=103;,citation_journal_title=Journal of clinical epidemiology;,citation_publisher=Elsevier;">
<meta name="citation_reference" content="citation_title=Regression shrinkage and selection via the lasso;,citation_author=Robert Tibshirani;,citation_publication_date=1996;,citation_cover_date=1996;,citation_year=1996;,citation_issue=1;,citation_volume=58;,citation_journal_title=Journal of the Royal Statistical Society Series B: Statistical Methodology;,citation_publisher=Oxford University Press;">
<meta name="citation_reference" content="citation_title=A package for survival analysis in r;,citation_author=Terry M Therneau;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://CRAN.R-project.org/package=survival;">
<meta name="citation_reference" content="citation_title=Data.table: Extension of ‘data.frame‘;,citation_author=Tyson Barrett;,citation_author=Matt Dowle;,citation_author=Arun Srinivasan;,citation_author=Jan Gorecki;,citation_author=Michael Chirico;,citation_author=Toby Hocking;,citation_author=Benjamin Schwendinger;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://CRAN.R-project.org/package=data.table;">
<meta name="citation_reference" content="citation_title=Evaluation and benchmarking;,citation_author=Giuseppe Casalicchio;,citation_author=Lukas Burk;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com/evaluation_and_benchmarking.html;,citation_inbook_title=Applied machine learning using mlr3 in R;">
<meta name="citation_reference" content="citation_title=mlr3data: Collection of machine learning data sets for ’mlr3’;,citation_author=Marc Becker;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://github.com/mlr-org/mlr3data;">
<meta name="citation_reference" content="citation_title=mlr3measures: Performance measures for ’mlr3’;,citation_author=Michel Lang;,citation_author=Marc Becker;,citation_author=Lona Koers;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://CRAN.R-project.org/package=mlr3measures;">
<meta name="citation_reference" content="citation_title=Hyperparameter optimization;,citation_author=Marc Becker;,citation_author=Lennart Schneider;,citation_author=Sebastian Fischer;,citation_editor=Bernd Bischl;,citation_editor=Raphael Sonabend;,citation_editor=Lars Kotthoff;,citation_editor=Michel Lang;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://mlr3book.mlr-org.com/hyperparameter_optimization.html;,citation_inbook_title=Applied machine learning using mlr3 in R;">
<meta name="citation_reference" content="citation_title=State of the art in selection of variables and functional forms in multivariable analysis—outstanding issues;,citation_author=Willi Sauerbrei;,citation_author=Aris Perperoglou;,citation_author=Matthias Schmid;,citation_author=Michal Abrahamowicz;,citation_author=Heiko Becher;,citation_author=Harald Binder;,citation_author=Daniela Dunkler;,citation_author=Frank E Harrell;,citation_author=Patrick Royston;,citation_author=Georg Heinze;,citation_author=others;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_volume=4;,citation_journal_title=Diagnostic and prognostic research;,citation_publisher=Springer;">
<meta name="citation_reference" content="citation_title=Evaluation of clinical prediction models (part 1): From development to external validation;,citation_author=Gary S Collins;,citation_author=Paula Dhiman;,citation_author=Jie Ma;,citation_author=Michael M Schlussel;,citation_author=Lucinda Archer;,citation_author=Ben Van Calster;,citation_author=Frank E Harrell;,citation_author=Glen P Martin;,citation_author=Karel GM Moons;,citation_author=Maarten Van Smeden;,citation_author=others;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_volume=384;,citation_journal_title=Bmj;,citation_publisher=British Medical Journal Publishing Group;">
</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Paul Smith</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://pws3141.github.io"> <i class="bi bi-house" role="img">
</i> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pws3141/blog"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Model Validation using the Bootstrap</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">r</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">model fitting</div>
                <div class="quarto-category">model validation</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Paul Smith </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 26, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#the-method" id="toc-the-method" class="nav-link" data-scroll-target="#the-method">The method</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data">The data</a></li>
  </ul></li>
  <li><a href="#sec-analysis" id="toc-sec-analysis" class="nav-link" data-scroll-target="#sec-analysis">Analysis</a>
  <ul class="collapse">
  <li><a href="#choosing-factors-manually" id="toc-choosing-factors-manually" class="nav-link" data-scroll-target="#choosing-factors-manually">Choosing factors manually</a>
  <ul class="collapse">
  <li><a href="#sec-manual-building" id="toc-sec-manual-building" class="nav-link" data-scroll-target="#sec-manual-building">Model building</a></li>
  <li><a href="#model-validation" id="toc-model-validation" class="nav-link" data-scroll-target="#model-validation">Model validation</a></li>
  </ul></li>
  <li><a href="#analysis-using-stepwise-selection" id="toc-analysis-using-stepwise-selection" class="nav-link" data-scroll-target="#analysis-using-stepwise-selection">Analysis Using Stepwise Selection</a>
  <ul class="collapse">
  <li><a href="#sec-complete-building" id="toc-sec-complete-building" class="nav-link" data-scroll-target="#sec-complete-building">Model building</a></li>
  <li><a href="#sec-complete-validation" id="toc-sec-complete-validation" class="nav-link" data-scroll-target="#sec-complete-validation">Model validation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>This is <em>Part Three</em> of a four part series on model fitting and validation.</p>
<ul>
<li><a href="../../../posts/modelbuilding/stepwise_datasplitting/index.html">Part One</a> considers some theoretical issues with data-splitting and using stepwise selection</li>
<li><a href="../../../posts/modelbuilding/stepwise_datasplitting_simulation/index.html">Part Two</a> looks at simulating the effect of data-splitting and stepwise selection in model building and validation on the <code>lung</code> dataset, including:
<ul>
<li>The variability of model terms chosen and the coefficient estimates from data-splitting and using stepwise selection;</li>
<li>The variability in the C-statistic obtained from the test set.</li>
</ul></li>
</ul>
<section id="introduction" class="level1 page-columns page-full">
<h1>Introduction</h1>
<p>In this part, I look at using the bootstrap to validate a model. Much of this work is inspired by the excellent book by <span class="citation" data-cites="harrell2001regression">Harrell et al. (<a href="#ref-harrell2001regression" role="doc-biblioref">2001</a>)</span>. Using the bootstrap to validate a model means that data-splitting is not required, and instead both model building and validation can be performed on the full dataset. As discussed by Harrell in a <a href="https://www.fharrell.com/post/split-val/">post</a>,</p>
<div class="no-row-height column-margin column-container"></div><blockquote class="blockquote">
<p>Data are too precious to not be used in model development/parameter estimation. Resampling methods allow the data to be used for both development and validation, and they do a good job in estimating the likely future performance of a model.</p>
</blockquote>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The hierarchy of validation methods
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In <span class="citation" data-cites="harrell2001regression">Harrell et al. (<a href="#ref-harrell2001regression" role="doc-biblioref">2001, vol. 608, chap. 5.2</a>)</span>, a hierarchy of validation methods is given, from worst to best.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<ol type="1">
<li>Attempting several validations (internal or external) and reporting only the one that “worked”</li>
<li>Reporting apparent performance on the training dataset (no validation)</li>
<li>Reporting predictive accuracy on an undersized independent test sample</li>
<li>Internal validation using data-splitting where at least one of the training and test samples is not huge and the investigator is not aware of the arbitrariness of variable selection done on a single sample</li>
<li>Strong internal validation using 100 repeats of 10-fold cross-validation or several hundred bootstrap resamples, repeating all analysis steps involving <span class="math inline">\(Y\)</span> afresh at each re-sample and the arbitrariness of selected “important variables” is reported (if variable selection is used)</li>
<li>External validation on a large test sample, done by the original research team</li>
<li>Re-analysis by an independent research team using strong internal validation of the original dataset</li>
<li>External validation using new test data, done by an independent research team</li>
<li>External validation using new test data generated using different instruments/technology, done by an independent research team</li>
</ol>
<p>In this post, I am looking at option (5). Currently at work we often rely on (3) or (4).</p>
</div>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Specifically, “one suggested hierarchy”, so I’m unsure whether this is Harrell’s suggested one or not…</p></div></div><div class="no-row-height column-margin column-container"></div><section id="the-method" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-method">The method</h2>
<p>I will only consider complete-case data for now, and will consider two different scenarios.</p>
<ol type="1">
<li>Model fitting where we already “know” the factors in the model.</li>
<li>Model building and fitting, where we use stepwise to select the factors in the model.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why stepwise?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I am using stepwise here for simplicity. The lasso would be better (although it still <a href="../../../posts/modelbuilding/stepwise_datasplitting/index.html">shares many of stepwise’s flaws</a>). Using expert judgement to choose variables is much better, and means it is much harder to hide behind the computer.</p>
<p>I’m waiting with baited breath for guidance from the <a href="https://stratos-initiative.org/group_2"><em>STRengthening Analytical Thinking for Observational Studies</em> (STRATOS)</a> initiative on variable selection techniques for multivariate analysis, but I’m not sure it’s coming anytime soon <span class="citation" data-cites="sauerbrei2020state">(<a href="#ref-sauerbrei2020state" role="doc-biblioref">Sauerbrei et al. 2020</a>)</span>.</p>
</div>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="ref-sauerbrei2020state" class="csl-entry" role="listitem">
Sauerbrei, Willi, Aris Perperoglou, Matthias Schmid, Michal Abrahamowicz, Heiko Becher, Harald Binder, Daniela Dunkler, et al. 2020. <span>“State of the Art in Selection of Variables and Functional Forms in Multivariable Analysis—Outstanding Issues.”</span> <em>Diagnostic and Prognostic Research</em> 4: 1–18.
</div><div id="ref-harrell2001regression" class="csl-entry" role="listitem">
Harrell, Frank E et al. 2001. <em>Regression Modeling Strategies: With Applications to Linear Models, Logistic Regression, and Survival Analysis</em>. Vol. 608. Springer.
</div></div><p>The method for model validation in this article is based on <span class="citation" data-cites="harrell2001regression">Harrell et al. (<a href="#ref-harrell2001regression" role="doc-biblioref">2001, vol. 608, chap. 5.3.5</a>)</span>, which describes the process of calculating an optimism-corrected accuracy metric using bootstrap resampling as:</p>
<blockquote class="blockquote">
<p>From the original <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> in the sample of size <span class="math inline">\(n\)</span>, draw a sample with replacement also of size <span class="math inline">\(n\)</span>. Derive a model in the bootstrap sample and apply it without change to the original sample. The accuracy index from the bootstrap sample minus the index computed on the original sample is an estimate of optimism. This process is repeated for <span class="math inline">\(100\)</span> or so bootstrap replications to obtain an average optimism, which is subtracted from the final model fit’s apparent accuracy to obtain the overfitting-corrected estimate.</p>
</blockquote>
<p>He goes on…</p>
<blockquote class="blockquote">
<p>Note that bootstrapping validates the <em>process</em> that was used to fit the original model (as does cross-validation). It provides an estimate of the expected value of the optimism, which when subtracted from the original index, provides an estimate of the expected bias-corrected index. If stepwise variable selection is part of the bootstrap process (<em>as it must be if the final model is developed that way</em>), and not all resamples (samples with replacement or training samples in cross-validation) resulted in the same model (which is almost always the case), this internal validation process actually provides an unbiased estimate of the future performance of the process used to identify markers and scoring systems; it does not validate a single final model. But resampling does tend to provide good estimates of the future performance of the final model that was selected using the same procedure repeated in the resamples.</p>
</blockquote>
<p>A good introduction to model building and internal validation is given in <span class="citation" data-cites="collins2024evaluation">Collins et al. (<a href="#ref-collins2024evaluation" role="doc-biblioref">2024</a>)</span>. See <em>Box 2</em> for a simple explanation of the bootstrapping internal validation method.</p>
<div class="no-row-height column-margin column-container"><div id="ref-collins2024evaluation" class="csl-entry" role="listitem">
Collins, Gary S, Paula Dhiman, Jie Ma, Michael M Schlussel, Lucinda Archer, Ben Van Calster, Frank E Harrell, et al. 2024. <span>“Evaluation of Clinical Prediction Models (Part 1): From Development to External Validation.”</span> <em>Bmj</em> 384.
</div></div><p>I have clarified this procedure where appropriate in <a href="#sec-analysis" class="quarto-xref">Section&nbsp;2</a>.</p>
</section>
<section id="the-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-data">The data</h2>
<p>The examples will be performed on the complete-case of <a href="https://stat.ethz.ch/R-manual/R-devel/library/survival/html/pbc.html"><code>pbc</code></a> data from the <code>{survival}</code> package <span class="citation" data-cites="therneau2024survival">(<a href="#ref-therneau2024survival" role="doc-biblioref">Therneau 2024</a>)</span>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="ref-therneau2024survival" class="csl-entry" role="listitem">
Therneau, Terry M. 2024. <em>A Package for Survival Analysis in r</em>. <a href="https://CRAN.R-project.org/package=survival">https://CRAN.R-project.org/package=survival</a>.
</div><div id="fn2"><p><sup>2</sup>&nbsp;In my next post I’ll be considering the full dataset and use multiple imputation to handle the missing data.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.nrows =</span> <span class="dv">20</span>) <span class="co"># max # rows before truncating (default = 100)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rms) <span class="co"># for 'validate'</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># load pbc dataset</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(pbc)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>pbc <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(pbc)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>pbc[, status <span class="sc">:</span><span class="er">=</span> <span class="fu">fifelse</span>(status <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>)]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="do">## used in 'step()' below</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># creating upper and lower model for stepwise selection</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># create upper scope (everything except 'id' and outcome variables)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>upper_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(pbc), <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"status"</span>, <span class="st">"id"</span>)), </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                             <span class="at">collapse =</span> <span class="st">" + "</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>scope <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">upper =</span> <span class="fu">reformulate</span>(upper_names),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="sc">~</span><span class="dv">1</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># complete case</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>pbc_complete <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(pbc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a dataset of patients with primary biliary cirrhosis, and has 276 observations (compared to 418 observations in the full <code>pbc</code> dataset). Throughout this post I will use <span class="math inline">\(B = 100\)</span> bootstrap iterations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of bootstrap iterations</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sec-analysis" class="level1 page-columns page-full">
<h1>Analysis</h1>
<table class="table">
<colgroup>
<col style="width: 45%">
<col style="width: 54%">
</colgroup>
<thead>
<tr class="header">
<th>Notation</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(X \in \mathbb{R}^{n \times p}\)</span></td>
<td>dataset containing missingness (<code>pbc</code>)</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\tilde{X} \in \mathbb{R}^{n \times \tilde{p}}\)</span></td>
<td>complete-case dataset (<code>pbc_complete</code>)</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(X^{(i)}\)</span> (or <span class="math inline">\(\tilde{X}^{(i)}\)</span>)</td>
<td><span class="math inline">\(i\)</span>-th bootstrap dataset (or complete-case dataset), <span class="math inline">\(i = 1,\dots,B\)</span></td>
</tr>
</tbody>
</table>
<section id="choosing-factors-manually" class="level2">
<h2 class="anchored" data-anchor-id="choosing-factors-manually">Choosing factors manually</h2>
<p>In this section, I consider building a model and validating it, when the factors are chosen in the model <em>a-priori</em>.</p>
<section id="sec-manual-building" class="level3">
<h3 class="anchored" data-anchor-id="sec-manual-building">Model building</h3>
<p><span class="math display">\[
\begin{align}
  \text{Data:}\quad&amp;\tilde{X}\\
  &amp;\\
  &amp;\downarrow \quad \color{gray}{\text{Factors chosen a-priori}}\\
  &amp;\\
  \text{Model:}\quad&amp;\mathcal{M}
\end{align}
\]</span></p>
<section id="the-example" class="level4">
<h4 class="anchored" data-anchor-id="the-example">The example</h4>
<p>I will build a model using the following factors: <code>age</code>, <code>ascites</code>, <code>edema</code>, <code>albumin</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a Cox PH model to pbc</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>cox1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> ascites <span class="sc">+</span> edema <span class="sc">+</span> albumin, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> pbc_complete)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ age + ascites + edema + 
    albumin, data = pbc_complete)

  n= 276, number of events= 111 

             coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
age      0.029756  1.030203  0.009434  3.154 0.001610 ** 
ascites  0.795809  2.216234  0.337631  2.357 0.018421 *  
edema    1.603254  4.969174  0.323922  4.950 7.44e-07 ***
albumin -1.041877  0.352792  0.274523 -3.795 0.000148 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
age        1.0302     0.9707     1.011    1.0494
ascites    2.2162     0.4512     1.143    4.2954
edema      4.9692     0.2012     2.634    9.3758
albumin    0.3528     2.8345     0.206    0.6042

Concordance= 0.757  (se = 0.027 )
Likelihood ratio test= 95.51  on 4 df,   p=&lt;2e-16
Wald test            = 116.5  on 4 df,   p=&lt;2e-16
Score (logrank) test = 172.7  on 4 df,   p=&lt;2e-16</code></pre>
</div>
</div>
</section>
</section>
<section id="model-validation" class="level3">
<h3 class="anchored" data-anchor-id="model-validation">Model validation</h3>
<p>First, <span class="math inline">\(B\)</span> bootstrap datasets are created, and models fitted to each of these:</p>
<p><span class="math display">\[
\begin{align}
  \text{Data:}\quad\quad\quad&amp;\tilde{X}&amp;&amp;&amp;&amp;\\
  \\
  &amp;\downarrow\\
  \\
  \text{Bootstrapped data:}\quad\quad&amp;\tilde{X}^{(1)} \quad &amp;&amp;\tilde{X}^{(2)} \quad &amp;&amp;\ldots \quad &amp;&amp;\tilde{X}^{(B)}\\
  \\
  &amp;\downarrow &amp;&amp; \downarrow  &amp;&amp;\ldots &amp;&amp;\downarrow \quad\color{gray}{\text{Same factors as original model building (chosen a-priori)}}\\
  \\
  \text{Models:}\quad\quad &amp;\mathcal{M}^{(1)} \quad &amp;&amp;\mathcal{M}^{(2)} \quad &amp;&amp;\ldots \quad &amp;&amp;\mathcal{M}^{(B)}\\
\end{align}
\]</span></p>
<p>Then, calculating the optimism-corrected C-statistic involves:</p>
<ol type="1">
<li>Calculate the C-statistic obtained from the original model <span class="math inline">\(\mathcal{M}\)</span> (from <a href="#sec-manual-building" class="quarto-xref">Section&nbsp;2.1.1</a>), fitted to the complete-case dataset <span class="math inline">\(\tilde{X}\)</span>, denoted <span class="math inline">\(c\)</span>.</li>
<li>For <span class="math inline">\(b = 1, 2, \ldots, B\)</span>:
<ol type="i">
<li>Calculate the C-statistic from the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(\mathcal{M}^{(b)}\)</span>, fitted to the <span class="math inline">\(b^\text{th}\)</span> bootstrap dataset <span class="math inline">\(\tilde{X}^{(b)}\)</span>, denoted <span class="math inline">\(c^{(b)}\)</span>.</li>
<li>Calculate the C-statistic from the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(\mathcal{M}^{(b)}\)</span>, fitted to the original dataset, <span class="math inline">\(\tilde{X}\)</span>, denoted <span class="math inline">\(c^{(b)}_X\)</span>.</li>
<li>Calculate the optimism for the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(o^{(b)} = c^{(b)} - c^{(b)}_X\)</span>.</li>
</ol></li>
<li>Calculate the mean optimism, <span class="math inline">\(\bar{o} = \frac{1}{B} \sum_{b=1}^{B} o^{(b)}\)</span>.</li>
<li>Calculate the optimism-corrected C-statistic, <span class="math display">\[
  c_\text{opt} = c - \bar{o}.
\]</span></li>
</ol>
<section id="the-example-1" class="level4">
<h4 class="anchored" data-anchor-id="the-example-1">The example</h4>
<p>First, I obtain the (optimistic) C-statistic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> <span class="fu">concordance</span>(cox1)<span class="sc">$</span>concordance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we follow Steps (2) - (4) above to obtain the optimism-corrected C-statistic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of bootstrap samples</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>c_boots1 <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="fu">seq_len</span>(B), <span class="cf">function</span>(b) {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2a. create bootstrap sample</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(pbc_complete), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      pbc_boot <span class="ot">&lt;-</span> pbc_complete[idx]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2b. fit model</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      cox_boot <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> ascites <span class="sc">+</span> edema <span class="sc">+</span> albumin, </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> pbc_boot)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2c. </span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate concordance on bootstrap sample</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      c_stat_boot <span class="ot">&lt;-</span> <span class="fu">concordance</span>(cox_boot)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2d.</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># predict on original data</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      lp_X <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox_boot, <span class="at">newdata =</span> pbc_complete, <span class="at">type =</span> <span class="st">"lp"</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate concordance on original data</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      c_stat_X <span class="ot">&lt;-</span> <span class="fu">concordance</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> lp_X, </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> pbc_complete, <span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      c_boot <span class="ot">&lt;-</span> c_stat_boot<span class="sc">$</span>concordance</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      c_x <span class="ot">&lt;-</span> c_stat_X<span class="sc">$</span>concordance</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># save c stats and calculate optimism</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.table</span>(<span class="at">c_boot =</span> c_boot, <span class="at">c_x =</span> c_x, <span class="at">optimism =</span> c_boot <span class="sc">-</span> c_x)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(c_boots1, <span class="at">topn =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        c_boot       c_x     optimism
         &lt;num&gt;     &lt;num&gt;        &lt;num&gt;
  1: 0.7414303 0.7518621 -0.010431756
  2: 0.7249516 0.7552477 -0.030296102
  3: 0.7277843 0.7552477 -0.027463354
  4: 0.7299828 0.7534767 -0.023493912
  5: 0.7489701 0.7543622 -0.005392114
 ---                                 
 96: 0.7580732 0.7539455  0.004127666
 97: 0.7296153 0.7548831 -0.025267743
 98: 0.8220811 0.7535809  0.068500184
 99: 0.7695147 0.7469660  0.022548752
100: 0.7220383 0.7516537 -0.029615478</code></pre>
</div>
</div>
<p>Now, we can compute the mean optimism, <span class="math inline">\(\bar{o}\)</span>, and the overfitting-corrected estimate of accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. mean difference</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>optimism_mean1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(c_boots1<span class="sc">$</span>optimism)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. overfitting-corrected estimate of accuracy</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>c_opt1 <span class="ot">&lt;-</span> c1 <span class="sc">-</span> optimism_mean1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, the original C-statistic was 0.7565, compared to the bias-corrected estimate of 0.7547.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The quick code
</div>
</div>
<div class="callout-body-container callout-body">
<p>This can be done in a few lines lines, using the <code>{rms}</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># validate</span></span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a>cox1_cph <span class="ot">&lt;-</span> rms<span class="sc">::</span><span class="fu">cph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> ascites <span class="sc">+</span> edema <span class="sc">+</span> albumin, </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1">1</button><span id="annotated-cell-12-4" class="code-annotation-target"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> pbc_complete, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a>bias_corrected_metrics1 <span class="ot">&lt;-</span> rms<span class="sc">::</span><span class="fu">validate</span>(cox1_cph, <span class="at">B =</span> <span class="dv">100</span>)</span>
<span id="annotated-cell-12-6"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a>bias_corrected_metrics1</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="4" data-code-annotation="1"><code>rms::validate()</code> requires the model to be fit using <code>rms::cph()</code> instead of <code>survival::coxph()</code>.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>      index.orig training   test optimism index.corrected   n
Dxy       0.5131   0.5072 0.5035   0.0037          0.5094 100
R2        0.2981   0.3038 0.2865   0.0173          0.2807 100
Slope     1.0000   1.0000 0.9359   0.0641          0.9359 100
D         0.0859   0.0892 0.0819   0.0073          0.0786 100
U        -0.0018  -0.0018 0.0025  -0.0044          0.0025 100
Q         0.0877   0.0910 0.0794   0.0116          0.0761 100
g         0.9916   1.0087 0.9469   0.0619          0.9298 100</code></pre>
</div>
</div>
<p>For a detailed explanation of the <code>validate</code> output, see John Haman’s <a href="https://randomeffect.net/post/2021/05/02/the-rms-validate-function/">website</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>c1_rms <span class="ot">&lt;-</span> (bias_corrected_metrics1[<span class="st">"Dxy"</span>, <span class="st">"index.corrected"</span>] <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>c1_rms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7546952</code></pre>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="analysis-using-stepwise-selection" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="analysis-using-stepwise-selection">Analysis Using Stepwise Selection</h2>
<p>The model building stage (<a href="#sec-complete-building" class="quarto-xref">Section&nbsp;2.2.1</a>) is done using stepwise selection, and the model validation stage (<a href="#sec-complete-validation" class="quarto-xref">Section&nbsp;2.2.2</a>) is done using bootstrapping. The model building and validation stages are shown below.</p>
<section id="sec-complete-building" class="level3">
<h3 class="anchored" data-anchor-id="sec-complete-building">Model building</h3>
<p>Here, I perform stepwise selection on the complete-case dataset, starting from the null model.</p>
<p><span class="math display">\[
\begin{align}
  \text{Data:}\quad&amp;\tilde{X}\\
  &amp;\\
  &amp;\downarrow \quad \color{gray}{\text{Stepwise selection}}\\
  &amp;\\
  \text{Model:}\quad&amp;\mathcal{M}
\end{align}
\]</span></p>
<section id="sec-analysis-stepwise-building-example" class="level4">
<h4 class="anchored" data-anchor-id="sec-analysis-stepwise-building-example">The example</h4>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">The code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">The output</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a Cox PH model to pbc: start with the null model</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>cox_null <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> pbc_complete)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use stepwise selection (minimising AIC)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># creating upper and lower model for stepwise selection</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create upper scope (everything except 'id' and outcome variables)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>upper_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(pbc), <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"status"</span>, <span class="st">"id"</span>)), </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">collapse =</span> <span class="st">" + "</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>scope <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">upper =</span> <span class="fu">reformulate</span>(upper_names),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="sc">~</span><span class="dv">1</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>cox2 <span class="ot">&lt;-</span> <span class="fu">step</span>(cox_null, <span class="at">scope =</span> scope, <span class="at">trace =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ bili + stage + copper + 
    albumin + protime + age + edema + ast, data = pbc_complete)

  n= 276, number of events= 111 

              coef  exp(coef)   se(coef)      z Pr(&gt;|z|)    
bili     0.0851214  1.0888492  0.0193352  4.402 1.07e-05 ***
stage    0.4327939  1.5415584  0.1456307  2.972  0.00296 ** 
copper   0.0028535  1.0028576  0.0009832  2.902  0.00370 ** 
albumin -0.7185954  0.4874364  0.2724486 -2.638  0.00835 ** 
protime  0.2275175  1.2554794  0.1013729  2.244  0.02481 *  
age      0.0313836  1.0318812  0.0102036  3.076  0.00210 ** 
edema    0.8217952  2.2745795  0.3471465  2.367  0.01792 *  
ast      0.0043769  1.0043865  0.0018067  2.423  0.01541 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
bili       1.0888     0.9184    1.0484    1.1309
stage      1.5416     0.6487    1.1588    2.0508
copper     1.0029     0.9972    1.0009    1.0048
albumin    0.4874     2.0515    0.2858    0.8314
protime    1.2555     0.7965    1.0292    1.5314
age        1.0319     0.9691    1.0114    1.0527
edema      2.2746     0.4396    1.1519    4.4915
ast        1.0044     0.9956    1.0008    1.0079

Concordance= 0.845  (se = 0.019 )
Likelihood ratio test= 163.8  on 8 df,   p=&lt;2e-16
Wald test            = 176.1  on 8 df,   p=&lt;2e-16
Score (logrank) test = 257.5  on 8 df,   p=&lt;2e-16</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="sec-complete-validation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="sec-complete-validation">Model validation</h3>
<p>The model validation stage is done using bootstrapping. The bootstrap procedure – starting from the complete-case dataset <span class="math inline">\(\tilde{X}\)</span> (which is the same as used in the model building stage) – is as follows.</p>
<p>First, <span class="math inline">\(B\)</span> bootstrap datasets are created, and models fitted to each of these (using the same stepwise procedure as in <a href="#sec-complete-building" class="quarto-xref">Section&nbsp;2.2.1</a>):</p>
<p><span class="math display">\[
\begin{align}
  \text{Data:}\quad\quad\quad&amp;\tilde{X}&amp;&amp;&amp;&amp;\\
  \\
  &amp;\downarrow\\
  \\
  \text{Bootstrapped data:}\quad\quad&amp;\tilde{X}^{(1)} \quad &amp;&amp;\tilde{X}^{(2)} \quad &amp;&amp;\ldots \quad &amp;&amp;\tilde{X}^{(B)}\\
  \\
  &amp;\downarrow &amp;&amp; \downarrow  &amp;&amp;\ldots &amp;&amp;\downarrow \quad\color{gray}{\text{Stepwise selection}}\\
  \\
  \text{Models:}\quad\quad &amp;\mathcal{M}^{(1)} \quad &amp;&amp;\mathcal{M}^{(2)} \quad &amp;&amp;\ldots \quad &amp;&amp;\mathcal{M}^{(B)}\\
\end{align}
\]</span></p>
<p>Then, calculating the optimism-corrected C-statistic involves:</p>
<ol type="1">
<li>Calculate the C-statistic obtained from the original model <span class="math inline">\(\mathcal{M}\)</span> (from <a href="#sec-complete-building" class="quarto-xref">Section&nbsp;2.2.1</a>), fitted to the complete-case dataset <span class="math inline">\(\tilde{X}\)</span>, denoted <span class="math inline">\(c\)</span>.</li>
<li>For <span class="math inline">\(b = 1, 2, \ldots, B\)</span>:
<ol type="i">
<li>Calculate the C-statistic from the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(\mathcal{M}^{(b)}\)</span>, fitted to the <span class="math inline">\(b^\text{th}\)</span> bootstrap dataset <span class="math inline">\(\tilde{X}^{(b)}\)</span>, denoted <span class="math inline">\(c^{(b)}\)</span>.</li>
<li>Calculate the C-statistic from the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(\mathcal{M}^{(b)}\)</span>, fitted to the original dataset, <span class="math inline">\(\tilde{X}\)</span>, denoted <span class="math inline">\(c^{(b)}_X\)</span>.</li>
<li>Calculate the optimism for the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(o^{(b)} = c^{(b)} - c^{(b)}_X\)</span>.</li>
</ol></li>
<li>Calculate the mean optimism, <span class="math inline">\(\bar{o} = \frac{1}{B} \sum_{b=1}^{B} o^{(b)}\)</span>.</li>
<li>Calculate the optimism-corrected C-statistic, <span class="math display">\[
  c_\text{opt} = c - \bar{o}.
\]</span></li>
</ol>
<section id="the-example-2" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="the-example-2">The example</h4>
<p>First, I obtain the (optimistic) C-statistic<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, as described in Step (1).</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;The C-statistic obtained from the original model <span class="math inline">\(\mathcal{M}\)</span> (from <a href="#sec-complete-building" class="quarto-xref">Section&nbsp;2.2.1</a>), fitted to the complete-case dataset <span class="math inline">\(\tilde{X}\)</span>.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="fu">concordance</span>(cox2)<span class="sc">$</span>concordance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, follow Step (2) to obtain the C-statistic from the <span class="math inline">\(b^\text{th}\)</span> bootstrap model <span class="math inline">\(\mathcal{M}^{(b)}\)</span>, fitted to both the bootstrap dataset,<span class="math inline">\(\tilde{X}^{(b)}\)</span>, and the original dataset, <span class="math inline">\(\tilde{X}\)</span>. From these the <span class="math inline">\(b^\text{th}\)</span> bootstrap model optimism can be calculated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># start time of execution</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>total_time_start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>c_boots <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="fu">seq_len</span>(B), <span class="cf">function</span>(b) {</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># start time of inner execution</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2a. create bootstrap sample</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(pbc_complete), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>      pbc_boot <span class="ot">&lt;-</span> pbc_complete[idx]</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2b. fit null model</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>      cox_boot_null <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> pbc_boot)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># use stepwise selection (minimising AIC)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      cox_boot <span class="ot">&lt;-</span> <span class="fu">step</span>(cox_boot_null, <span class="at">scope =</span> scope, <span class="at">trace =</span> <span class="dv">0</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2c. </span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>      c_boot <span class="ot">&lt;-</span> <span class="fu">concordance</span>(cox_boot)<span class="sc">$</span>concordance</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2d.</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># predict on original data</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>      lp_X <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox_boot, <span class="at">newdata =</span> pbc_complete, <span class="at">type =</span> <span class="st">"lp"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate concordance on original data</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>      c_x <span class="ot">&lt;-</span> <span class="fu">concordance</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> lp_X, </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> pbc_complete, <span class="at">reverse =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>concordance</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># end time of inner execution</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>      end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>      time_taken <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># save c stats and calculate optimism</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.table</span>(<span class="at">c_boot =</span> c_boot, <span class="at">c_x =</span> c_x, <span class="at">optimism =</span> c_boot <span class="sc">-</span> c_x,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                 <span class="at">time =</span> time_taken)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="co"># end time of inner execution</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>total_time_end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>total_time_taken <span class="ot">&lt;-</span> total_time_end <span class="sc">-</span> total_time_start</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(c_boots, <span class="at">topn =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        c_boot       c_x     optimism           time
         &lt;num&gt;     &lt;num&gt;        &lt;num&gt;     &lt;difftime&gt;
  1: 0.8538053 0.8443148  0.009490538 0.1987031 secs
  2: 0.8293180 0.8343143 -0.004996320 0.2695990 secs
  3: 0.8455517 0.8346268  0.010924944 0.2656732 secs
  4: 0.8362208 0.8348872  0.001333566 0.3547299 secs
  5: 0.8589161 0.8320225  0.026893555 0.1707869 secs
 ---                                                
 96: 0.8501148 0.8251992  0.024915579 0.1238530 secs
 97: 0.8402561 0.8210323  0.019223753 0.3700459 secs
 98: 0.8800687 0.8248346  0.055234084 0.2577620 secs
 99: 0.8755016 0.8236366  0.051864931 0.2591660 secs
100: 0.8329462 0.8116048  0.021341406 0.2755342 secs</code></pre>
</div>
</div>
<p>This process took 23.74 secs in total.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;On my Macbook Air M3.</p></div></div><p>Now, I compute the mean optimism, <span class="math inline">\(\bar{o}\)</span>, and the overfitting-corrected estimate of accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (3) mean optimism</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>optimism_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(c_boots<span class="sc">$</span>optimism)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (4) optimism-corrected estimate of accuracy</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>c_opt <span class="ot">&lt;-</span> c <span class="sc">-</span> optimism_mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, the original C-statistic was <span class="math inline">\(c =\)</span> 0.8454, compared to the bias-corrected estimate of <span class="math inline">\(c_\text{opt}=\)</span> 0.8235. The mean of the optimism was <span class="math inline">\(\bar{o} =\)</span> 0.0218.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using <code>rms::validate()</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>validate()</code> function cannot be used here; it doesn’t validate the <em>whole process</em>, as the stepwise procedure is not repeated. That is, <code>validate</code> assumes the model is fixed for every bootstrap iteration. This means that the mean optimism will be smaller than the one obtained above, and therefore the ‘optimism-adjusted’ C-statistic will be higher than it should be.</p>
<p>The model found from the stepwise procedure in <a href="#sec-analysis-stepwise-building-example" class="quarto-xref">Section&nbsp;2.2.1.1</a> is,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">formula</span>(cox2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Surv(time, status) ~ bili + stage + copper + albumin + protime + 
    age + edema + ast
&lt;environment: 0x12251e7e0&gt;</code></pre>
</div>
</div>
<p>So, assuming this model form is constant throughout:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-21"><pre class="sourceCode r code-annotation-code code-with-copy"><code class="sourceCode r"><span id="annotated-cell-21-1"><a href="#annotated-cell-21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># validate</span></span>
<span id="annotated-cell-21-2"><a href="#annotated-cell-21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="annotated-cell-21-3"><a href="#annotated-cell-21-3" aria-hidden="true" tabindex="-1"></a>cox2_cph <span class="ot">&lt;-</span> rms<span class="sc">::</span><span class="fu">cph</span>(<span class="fu">formula</span>(cox2),</span>
<span id="annotated-cell-21-4"><a href="#annotated-cell-21-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> pbc_complete, <span class="at">x =</span> <span class="cn">TRUE</span>, <span class="at">y =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-21-5"><a href="#annotated-cell-21-5" aria-hidden="true" tabindex="-1"></a>bias_corrected_metrics2 <span class="ot">&lt;-</span> rms<span class="sc">::</span><span class="fu">validate</span>(cox2_cph, <span class="at">B =</span> <span class="dv">100</span>)</span>
<span id="annotated-cell-21-6"><a href="#annotated-cell-21-6" aria-hidden="true" tabindex="-1"></a>bias_corrected_metrics2</span>
<span id="annotated-cell-21-7"><a href="#annotated-cell-21-7" aria-hidden="true" tabindex="-1"></a>c2_rms <span class="ot">&lt;-</span> (bias_corrected_metrics2[<span class="st">"Dxy"</span>, <span class="st">"index.corrected"</span>] <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="annotated-cell-21-8"><a href="#annotated-cell-21-8" aria-hidden="true" tabindex="-1"></a>c2_rms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      index.orig training   test optimism index.corrected   n
Dxy       0.6907   0.6950 0.6791   0.0159          0.6748 100
R2        0.4561   0.4700 0.4379   0.0321          0.4240 100
Slope     1.0000   1.0000 0.8994   0.1006          0.8994 100
D         0.1479   0.1561 0.1400   0.0161          0.1319 100
U        -0.0018  -0.0018 0.0049  -0.0068          0.0049 100
Q         0.1498   0.1579 0.1351   0.0228          0.1270 100
g         1.4660   1.5596 1.3985   0.1611          1.3049 100
[1] 0.8373867</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p><strong>What I’ve done:</strong> for both a predefined model and using a stepwise model building procedure, I have calculated the apparent performance C-statistic, and then adjusted for optimism. For the predefined model, it is possible to calculate the optimism easily using <code>rms::validate()</code>. However, when using a model building procedure it is required to do this manually as the whole process needs to be included in each bootstrap iteration.</p>
<p><strong>Next steps:</strong> model building and validation in the presence of missing data, using multiple imputation.</p>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{smith2025,
  author = {Smith, Paul and Smith, Paul},
  title = {Model {Validation} Using the {Bootstrap}},
  date = {2025-04-26},
  url = {https://pws3141.github.io/blog/posts/modelbuilding/bias_corrected_validation/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-smith2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Smith, Paul, and Paul Smith. 2025. <span>“Model Validation Using the
Bootstrap.”</span> April 26, 2025. <a href="https://pws3141.github.io/blog/posts/modelbuilding/bias_corrected_validation/">https://pws3141.github.io/blog/posts/modelbuilding/bias_corrected_validation/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/pws3141\.github\.io\/blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>